# æ··åˆæ¶æ„é¢†åŸŸå±‚å¼€å‘æŒ‡å—

## äº‹ä»¶æº¯æº + DDD + èšåˆæ ¹è®¾è®¡

## ğŸ“‹ æ–‡æ¡£ä¿¡æ¯

- **æ–‡æ¡£ç±»å‹**: æ··åˆæ¶æ„é¢†åŸŸå±‚å¼€å‘æŒ‡å—
- **æ–‡æ¡£ç‰ˆæœ¬**: v1.0
- **åˆ›å»ºæ—¥æœŸ**: 2024å¹´12æœˆ
- **æ–‡æ¡£çŠ¶æ€**: æ­£å¼ç‰ˆ
- **ç›®æ ‡è¯»è€…**: å¼€å‘å›¢é˜Ÿ
- **æ¶æ„æ„¿æ™¯**: ä¸šåŠ¡ä¸ºæ ¸å¿ƒã€äº‹ä»¶é©±åŠ¨ã€é¢†åŸŸå»ºæ¨¡

---

## ğŸ¯ é¢†åŸŸå±‚æ ¸å¿ƒåŸåˆ™

### æ··åˆæ¶æ„ä¸­çš„é¢†åŸŸå±‚èŒè´£

é¢†åŸŸå±‚æ˜¯æ··åˆæ¶æ„çš„**ä¸šåŠ¡æ ¸å¿ƒ**ï¼Œæ‰¿è½½ç€ä»¥ä¸‹å…³é”®èŒè´£ï¼š

- **ä¸šåŠ¡è§„åˆ™å°è£…**: æ‰€æœ‰æ ¸å¿ƒä¸šåŠ¡é€»è¾‘éƒ½åœ¨é¢†åŸŸå±‚
- **èšåˆæ ¹ç®¡ç†**: èšåˆæ ¹æ˜¯ä¸šåŠ¡ä¸€è‡´æ€§è¾¹ç•Œ
- **é¢†åŸŸäº‹ä»¶å‘å¸ƒ**: è®°å½•æ‰€æœ‰ä¸šåŠ¡çŠ¶æ€å˜æ›´
- **å€¼å¯¹è±¡å»ºæ¨¡**: é€šè¿‡å€¼å¯¹è±¡è¡¨è¾¾ä¸šåŠ¡æ¦‚å¿µ
- **é¢†åŸŸæœåŠ¡**: å¤„ç†è·¨èšåˆçš„å¤æ‚ä¸šåŠ¡é€»è¾‘

### ğŸš¨ é¢†åŸŸå±‚çº¯å‡€æ€§åŸåˆ™

**é¢†åŸŸå±‚å¿…é¡»ä¿æŒç»å¯¹çš„çº¯å‡€æ€§ï¼Œä¸èƒ½ä¸ä»»ä½•æŠ€æœ¯åŸºç¡€è®¾æ–½è€¦åˆï¼š**

#### âŒ ç¦æ­¢çš„ä¾èµ–

- **æ•°æ®åº“ç›¸å…³**: TypeORMã€Prismaã€Sequelizeç­‰ORMæ¡†æ¶
- **HTTPæ¡†æ¶**: NestJSè£…é¥°å™¨ï¼ˆ@Entityã€@Columnç­‰ï¼‰
- **ç¬¬ä¸‰æ–¹åº“**: axiosã€momentã€lodashç­‰å¤–éƒ¨å·¥å…·åº“
- **åŸºç¡€è®¾æ–½**: Redisã€æ¶ˆæ¯é˜Ÿåˆ—ã€æ–‡ä»¶ç³»ç»Ÿç­‰
- **æ¡†æ¶ç‰¹å®š**: ä»»ä½•ç‰¹å®šäºæ¡†æ¶çš„æ³¨è§£æˆ–ä¾èµ–æ³¨å…¥

#### âœ… å…è®¸çš„ä¾èµ–

- **çº¯TypeScript**: åŸºç¡€ç±»å‹ã€æ¥å£ã€æšä¸¾
- **é¢†åŸŸå…±äº«åº“**: @aiofix/domain-sharedä¸­çš„åŸºç¡€æŠ½è±¡
- **Node.jsåŸç”Ÿ**: ä»…é™Dateã€Errorç­‰åŸç”Ÿå¯¹è±¡
- **ä¸šåŠ¡é€»è¾‘**: çº¯ç²¹çš„ä¸šåŠ¡è®¡ç®—å’ŒéªŒè¯

#### ğŸ¯ çº¯å‡€æ€§ä»·å€¼

1. **æŠ€æœ¯ç‹¬ç«‹**: é¢†åŸŸé€»è¾‘ä¸å—æŠ€æœ¯é€‰å‹å½±å“
2. **æ˜“äºæµ‹è¯•**: æ— éœ€Mockå¤æ‚çš„å¤–éƒ¨ä¾èµ–
3. **å¯ç§»æ¤æ€§**: å¯ä»¥è½»æ¾è¿ç§»åˆ°ä¸åŒæŠ€æœ¯æ ˆ
4. **ä¸šåŠ¡èšç„¦**: å¼ºåˆ¶å¼€å‘è€…ä¸“æ³¨äºä¸šåŠ¡é€»è¾‘
5. **é•¿æœŸç¨³å®š**: ä¸šåŠ¡é€»è¾‘ä¸ä¼šå› æŠ€æœ¯æ¼”è¿›è€Œå˜åŒ–

### ğŸ©¸ å……è¡€æ¨¡å‹ vs è´«è¡€æ¨¡å‹

é¢†åŸŸå®ä½“å¿…é¡»é‡‡ç”¨**å……è¡€æ¨¡å‹**ï¼Œè€Œä¸æ˜¯è´«è¡€æ¨¡å‹ï¼š

#### âŒ è´«è¡€æ¨¡å‹ï¼ˆAnti-Patternï¼‰

```typescript
// è´«è¡€æ¨¡å‹ï¼šåªæœ‰æ•°æ®ï¼Œæ²¡æœ‰è¡Œä¸º
export class User {
  id: string;
  username: string;
  email: string;
  status: UserStatus;
  // åªæœ‰getter/setterï¼Œæ²¡æœ‰ä¸šåŠ¡é€»è¾‘
}

// ä¸šåŠ¡é€»è¾‘è¢«æ”¾åœ¨å¤–éƒ¨æœåŠ¡ä¸­
export class UserService {
  activateUser(user: User): void {
    if (user.status === UserStatus.ACTIVE) {
      throw new Error('ç”¨æˆ·å·²ç»æ˜¯æ¿€æ´»çŠ¶æ€');
    }
    user.status = UserStatus.ACTIVE; // ç›´æ¥ä¿®æ”¹æ•°æ®
  }
}
```

#### âœ… å……è¡€æ¨¡å‹ï¼ˆæ­£ç¡®åšæ³•ï¼‰

```typescript
// å……è¡€æ¨¡å‹ï¼šå°è£…æ•°æ®å’Œè¡Œä¸º
export class User extends BaseEntity {
  private _username: Username;
  private _email: Email;
  private _status: UserStatus;
  private _domainEvents: UserDomainEvent[] = [];

  // ä¸šåŠ¡æ–¹æ³•å°è£…åœ¨å®ä½“å†…éƒ¨
  activate(): void {
    if (this._status === UserStatus.ACTIVE) {
      throw new Error('ç”¨æˆ·å·²ç»æ˜¯æ¿€æ´»çŠ¶æ€');
    }

    if (this._status === UserStatus.DISABLED) {
      throw new Error('å·²ç¦ç”¨çš„ç”¨æˆ·ä¸èƒ½æ¿€æ´»');
    }

    const previousStatus = this._status;
    this._status = UserStatus.ACTIVE;
    this.updateTimestamp();

    // å‘å¸ƒé¢†åŸŸäº‹ä»¶
    this.addDomainEvent(
      new UserStatusChangedEvent(
        this.id.value,
        previousStatus,
        UserStatus.ACTIVE,
      ),
    );
  }

  // æ›´å¤šä¸šåŠ¡æ–¹æ³•...
  suspend(reason?: string): void {
    /* ä¸šåŠ¡é€»è¾‘ */
  }
  assignRole(roleId: Uuid): void {
    /* ä¸šåŠ¡é€»è¾‘ */
  }
  updateProfile(profile: UserProfile): void {
    /* ä¸šåŠ¡é€»è¾‘ */
  }
}
```

#### ğŸ¯ å……è¡€æ¨¡å‹çš„ä¼˜åŠ¿

1. **å°è£…æ€§**: æ•°æ®å’Œæ“ä½œæ•°æ®çš„è¡Œä¸ºå°è£…åœ¨ä¸€èµ·
2. **ä¸šåŠ¡è¡¨è¾¾**: ä»£ç ç›´æ¥è¡¨è¾¾ä¸šåŠ¡æ¦‚å¿µå’Œè§„åˆ™
3. **ä¸€è‡´æ€§**: é€šè¿‡å®ä½“æ–¹æ³•ä¿è¯æ•°æ®ä¸€è‡´æ€§
4. **å¤ç”¨æ€§**: ä¸šåŠ¡é€»è¾‘å¯ä»¥è¢«ä¸åŒåœºæ™¯å¤ç”¨
5. **å¯æµ‹è¯•æ€§**: å¯ä»¥ç›´æ¥æµ‹è¯•ä¸šåŠ¡é€»è¾‘
6. **å¯ç»´æŠ¤æ€§**: ä¸šåŠ¡å˜æ›´åªéœ€ä¿®æ”¹å®ä½“å†…éƒ¨

#### ğŸš¨ é¿å…è´«è¡€æ¨¡å‹çš„é™·é˜±

- **ä¸è¦**åªæä¾›getter/setterçš„æ•°æ®å®¹å™¨
- **ä¸è¦**æŠŠæ‰€æœ‰ä¸šåŠ¡é€»è¾‘æ”¾åœ¨Serviceå±‚
- **ä¸è¦**è®©å®ä½“å˜æˆçº¯ç²¹çš„æ•°æ®ä¼ è¾“å¯¹è±¡
- **ä¸è¦**å¿½è§†å®ä½“çš„è¡Œä¸ºè®¾è®¡

### æ¶æ„åˆ†å±‚ä¸­çš„ä½ç½®

```
å±•ç°å±‚ (Presentation) â† RESTful API
    â†“
åº”ç”¨å±‚ (Application) â† Use-Case ä¸šåŠ¡ç¼–æ’
    â†“
>>>>>>>>>> é¢†åŸŸå±‚ (Domain) â† ä¸šåŠ¡æ ¸å¿ƒ <<<<<<<<<<
    â†“
åŸºç¡€è®¾æ–½å±‚ (Infrastructure) â† æŠ€æœ¯å®ç°
```

### é¢†åŸŸå±‚ç»„ä»¶å…³ç³»

```
èšåˆæ ¹ (Aggregate Root)
    â†“ ç®¡ç†
å®ä½“ (Entity) + å€¼å¯¹è±¡ (Value Object)
    â†“ æ‰§è¡Œä¸šåŠ¡é€»è¾‘
é¢†åŸŸäº‹ä»¶ (Domain Event)
    â†“ è®°å½•çŠ¶æ€å˜æ›´
äº‹ä»¶å­˜å‚¨ (Event Store)
    â†“ é€šçŸ¥
åº”ç”¨å±‚äº‹ä»¶å¤„ç†å™¨ (Event Handlers)
```

---

## ğŸ“ é¢†åŸŸå±‚ç›®å½•ç»“æ„

```
src/{subdomain}/domain/
â”œâ”€â”€ aggregates/            # èšåˆæ ¹
â”‚   â”œâ”€â”€ {entity}-aggregate.ts
â”‚   â””â”€â”€ index.ts
â”œâ”€â”€ entities/              # å®ä½“
â”‚   â”œâ”€â”€ {entity}.entity.ts
â”‚   â””â”€â”€ index.ts
â”œâ”€â”€ value-objects/         # å€¼å¯¹è±¡
â”‚   â”œâ”€â”€ {object}.vo.ts
â”‚   â””â”€â”€ index.ts
â”œâ”€â”€ events/                # é¢†åŸŸäº‹ä»¶
â”‚   â”œâ”€â”€ {entity}-created.event.ts
â”‚   â”œâ”€â”€ {entity}-updated.event.ts
â”‚   â””â”€â”€ index.ts
â”œâ”€â”€ services/              # é¢†åŸŸæœåŠ¡
â”‚   â”œâ”€â”€ {domain}.service.ts
â”‚   â””â”€â”€ index.ts
â”œâ”€â”€ repositories/          # ä»“å‚¨æ¥å£
â”‚   â”œâ”€â”€ {entity}.repository.ts
â”‚   â””â”€â”€ index.ts
â”œâ”€â”€ exceptions/            # é¢†åŸŸå¼‚å¸¸
â”‚   â”œâ”€â”€ {domain}.exception.ts
â”‚   â””â”€â”€ index.ts
â””â”€â”€ index.ts              # å¯¼å‡ºæ–‡ä»¶
```

---

## ğŸ”§ å¼€å‘æ­¥éª¤

### æ­¥éª¤1: åˆ›å»ºå€¼å¯¹è±¡

å€¼å¯¹è±¡æ˜¯ä¸å¯å˜çš„ï¼Œé€šè¿‡å€¼æ¥å®šä¹‰ç›¸ç­‰æ€§ï¼š

```typescript
// domain/value-objects/username.vo.ts
/**
 * @class Username
 * @description ç”¨æˆ·åå€¼å¯¹è±¡
 *
 * ä¸»è¦åŸç†ä¸æœºåˆ¶ï¼š
 * 1. ä¸å¯å˜æ€§ï¼šåˆ›å»ºåä¸èƒ½ä¿®æ”¹
 * 2. å€¼ç›¸ç­‰æ€§ï¼šé€šè¿‡å€¼åˆ¤æ–­ç›¸ç­‰
 * 3. ä¸šåŠ¡è§„åˆ™å°è£…ï¼šç”¨æˆ·åæ ¼å¼éªŒè¯
 * 4. ç±»å‹å®‰å…¨ï¼šå¼ºç±»å‹çº¦æŸ
 *
 * åŠŸèƒ½ä¸ä¸šåŠ¡è§„åˆ™ï¼š
 * 1. ç”¨æˆ·åé•¿åº¦é™åˆ¶ï¼ˆ3-50å­—ç¬¦ï¼‰
 * 2. ç”¨æˆ·åæ ¼å¼éªŒè¯ï¼ˆå­—æ¯ã€æ•°å­—ã€ä¸‹åˆ’çº¿ï¼‰
 * 3. ç”¨æˆ·åå¤§å°å†™ä¸æ•æ„Ÿ
 */
export class Username {
  private readonly _value: string;

  constructor(value: string) {
    this.validate(value);
    this._value = value.toLowerCase();
  }

  get value(): string {
    return this._value;
  }

  equals(other: Username): boolean {
    if (!other) return false;
    return this._value === other._value;
  }

  toString(): string {
    return this._value;
  }

  private validate(value: string): void {
    if (!value) {
      throw new Error('ç”¨æˆ·åä¸èƒ½ä¸ºç©º');
    }

    if (value.length < 3 || value.length > 50) {
      throw new Error('ç”¨æˆ·åé•¿åº¦å¿…é¡»åœ¨3-50å­—ç¬¦ä¹‹é—´');
    }

    const usernameRegex = /^[a-zA-Z0-9_]+$/;
    if (!usernameRegex.test(value)) {
      throw new Error('ç”¨æˆ·ååªèƒ½åŒ…å«å­—æ¯ã€æ•°å­—å’Œä¸‹åˆ’çº¿');
    }
  }

  static create(value: string): Username {
    return new Username(value);
  }
}

// domain/value-objects/email.vo.ts
export class Email {
  private readonly _value: string;

  constructor(value: string) {
    this.validate(value);
    this._value = value.toLowerCase();
  }

  get value(): string {
    return this._value;
  }

  get domain(): string {
    return this._value.split('@')[1];
  }

  get localPart(): string {
    return this._value.split('@')[0];
  }

  equals(other: Email): boolean {
    if (!other) return false;
    return this._value === other._value;
  }

  toString(): string {
    return this._value;
  }

  private validate(value: string): void {
    if (!value) {
      throw new Error('é‚®ç®±ä¸èƒ½ä¸ºç©º');
    }

    const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
    if (!emailRegex.test(value)) {
      throw new Error('é‚®ç®±æ ¼å¼æ— æ•ˆ');
    }

    if (value.length > 254) {
      throw new Error('é‚®ç®±é•¿åº¦ä¸èƒ½è¶…è¿‡254å­—ç¬¦');
    }
  }

  static create(value: string): Email {
    return new Email(value);
  }
}
```

### æ­¥éª¤2: åˆ›å»ºé¢†åŸŸäº‹ä»¶

é¢†åŸŸäº‹ä»¶è®°å½•ä¸šåŠ¡çŠ¶æ€å˜æ›´ï¼š

```typescript
// domain/events/user-created.event.ts
import { BaseEvent } from '@aiofix/domain-shared';

/**
 * @class UserCreatedEvent
 * @description ç”¨æˆ·åˆ›å»ºäº‹ä»¶
 *
 * ä¸»è¦åŸç†ä¸æœºåˆ¶ï¼š
 * 1. ç»§æ‰¿BaseEventï¼Œè·å¾—äº‹ä»¶åŸºç¡€åŠŸèƒ½
 * 2. ä¸å¯å˜äº‹ä»¶æ•°æ®ï¼Œç¡®ä¿å†å²è®°å½•å®Œæ•´æ€§
 * 3. åŒ…å«å®Œæ•´çš„ä¸šåŠ¡ä¸Šä¸‹æ–‡ä¿¡æ¯
 * 4. æ”¯æŒäº‹ä»¶é‡æ”¾å’ŒçŠ¶æ€é‡å»º
 *
 * åŠŸèƒ½ä¸ä¸šåŠ¡è§„åˆ™ï¼š
 * 1. è®°å½•ç”¨æˆ·åˆ›å»ºçš„å®Œæ•´ä¿¡æ¯
 * 2. æ”¯æŒå®¡è®¡å’Œåˆè§„è¦æ±‚
 * 3. è§¦å‘åç»­ä¸šåŠ¡æµç¨‹
 */
export class UserCreatedEvent extends BaseEvent {
  public readonly userId: string;
  public readonly username: string;
  public readonly email: string;
  public readonly organizationId: string;
  public readonly profile: UserProfile;
  public readonly roleIds?: string[];

  constructor(
    userId: string,
    username: string,
    email: string,
    organizationId: string,
    profile: UserProfile,
    roleIds?: string[],
    tenantId?: string,
    operatorId?: string,
  ) {
    super(
      userId, // aggregateId
      'User', // aggregateType
      'UserCreated', // eventType
      1, // eventVersion
      tenantId,
      operatorId,
    );

    this.userId = userId;
    this.username = username;
    this.email = email;
    this.organizationId = organizationId;
    this.profile = profile;
    this.roleIds = roleIds;
  }

  static create(
    userId: string,
    username: string,
    email: string,
    organizationId: string,
    profile: UserProfile,
    roleIds?: string[],
    tenantId?: string,
    operatorId?: string,
  ): UserCreatedEvent {
    return new UserCreatedEvent(
      userId,
      username,
      email,
      organizationId,
      profile,
      roleIds,
      tenantId,
      operatorId,
    );
  }
}

// domain/events/user-updated.event.ts
export class UserUpdatedEvent extends BaseEvent {
  public readonly userId: string;
  public readonly changes: UserChanges;
  public readonly previousValues: Partial<UserData>;

  constructor(
    userId: string,
    changes: UserChanges,
    previousValues: Partial<UserData>,
    tenantId?: string,
    operatorId?: string,
  ) {
    super(userId, 'User', 'UserUpdated', 1, tenantId, operatorId);

    this.userId = userId;
    this.changes = changes;
    this.previousValues = previousValues;
  }
}
```

### æ­¥éª¤3: åˆ›å»ºå®ä½“

å®ä½“å…·æœ‰å”¯ä¸€æ ‡è¯†ï¼Œå°è£…ä¸šåŠ¡é€»è¾‘ï¼š

```typescript
// domain/entities/user.entity.ts
import { BaseEntity, Uuid } from '@aiofix/domain-shared';
import { Username } from '../value-objects/username.vo';
import { Email } from '../value-objects/email.vo';
import { UserCreatedEvent, UserUpdatedEvent } from '../events';

/**
 * @enum UserStatus
 * @description ç”¨æˆ·çŠ¶æ€æšä¸¾
 */
export enum UserStatus {
  PENDING = 'pending', // å¾…æ¿€æ´»
  ACTIVE = 'active', // æ´»è·ƒ
  SUSPENDED = 'suspended', // æš‚åœ
  LOCKED = 'locked', // é”å®š
  DISABLED = 'disabled', // ç¦ç”¨
}

/**
 * @interface UserProfile
 * @description ç”¨æˆ·æ¡£æ¡ˆä¿¡æ¯
 */
export interface UserProfile {
  firstName: string;
  lastName: string;
  avatar?: string;
  phone?: string;
  department?: string;
  title?: string;
}

/**
 * @class User
 * @description ç”¨æˆ·å®ä½“
 *
 * ä¸»è¦åŸç†ä¸æœºåˆ¶ï¼š
 * 1. ç»§æ‰¿BaseEntityï¼Œè·å¾—å®ä½“åŸºç¡€åŠŸèƒ½
 * 2. å°è£…ç”¨æˆ·ç›¸å…³çš„æ‰€æœ‰ä¸šåŠ¡é€»è¾‘
 * 3. ç»´æŠ¤ç”¨æˆ·çŠ¶æ€çš„ä¸€è‡´æ€§
 * 4. å‘å¸ƒé¢†åŸŸäº‹ä»¶è®°å½•çŠ¶æ€å˜æ›´
 *
 * åŠŸèƒ½ä¸ä¸šåŠ¡è§„åˆ™ï¼š
 * 1. ç”¨æˆ·ä¿¡æ¯ç®¡ç†å’ŒéªŒè¯
 * 2. ç”¨æˆ·çŠ¶æ€è½¬æ¢è§„åˆ™
 * 3. ç”¨æˆ·ç»„ç»‡å…³ç³»ç®¡ç†
 * 4. ç”¨æˆ·è§’è‰²åˆ†é…å’Œæƒé™ç»§æ‰¿
 */
export class User extends BaseEntity {
  private _username: Username;
  private _email: Email;
  private _status: UserStatus;
  private _profile: UserProfile;
  private _organizationId: Uuid;
  private _departmentIds: Set<Uuid> = new Set();
  private _roleIds: Set<Uuid> = new Set();
  private _tenantId: Uuid;
  private _lastLoginAt?: Date;
  private _failedLoginAttempts: number = 0;
  private _settings: Map<string, any> = new Map();
  private _metadata: Map<string, unknown> = new Map();

  // é¢†åŸŸäº‹ä»¶åˆ—è¡¨ï¼ˆç”¨äºèšåˆæ ¹ï¼‰
  private _domainEvents: UserDomainEvent[] = [];

  constructor(
    id: Uuid,
    username: Username,
    email: Email,
    organizationId: Uuid,
    tenantId: Uuid,
    profile: UserProfile,
    status: UserStatus = UserStatus.PENDING,
    createdAt?: Date,
    updatedAt?: Date,
    version?: number,
  ) {
    super(id, createdAt, updatedAt, version);
    this._username = username;
    this._email = email;
    this._organizationId = organizationId;
    this._tenantId = tenantId;
    this._profile = profile;
    this._status = status;
  }

  // Getters
  get username(): Username {
    return this._username;
  }

  get email(): Email {
    return this._email;
  }

  get status(): UserStatus {
    return this._status;
  }

  get profile(): UserProfile {
    return { ...this._profile };
  }

  get organizationId(): Uuid {
    return this._organizationId;
  }

  get tenantId(): Uuid {
    return this._tenantId;
  }

  get departmentIds(): Set<Uuid> {
    return new Set(this._departmentIds);
  }

  get roleIds(): Set<Uuid> {
    return new Set(this._roleIds);
  }

  get domainEvents(): UserDomainEvent[] {
    return [...this._domainEvents];
  }

  // ä¸šåŠ¡æ–¹æ³•

  /**
   * @method activate
   * @description æ¿€æ´»ç”¨æˆ·
   */
  activate(): void {
    if (this._status === UserStatus.ACTIVE) {
      throw new Error('ç”¨æˆ·å·²ç»æ˜¯æ¿€æ´»çŠ¶æ€');
    }

    if (this._status === UserStatus.DISABLED) {
      throw new Error('å·²ç¦ç”¨çš„ç”¨æˆ·ä¸èƒ½æ¿€æ´»');
    }

    const previousStatus = this._status;
    this._status = UserStatus.ACTIVE;
    this.updateTimestamp();

    this.addDomainEvent(
      new UserStatusChangedEvent(
        this.id.value,
        previousStatus,
        UserStatus.ACTIVE,
        this._tenantId.value,
      ),
    );
  }

  /**
   * @method suspend
   * @description æš‚åœç”¨æˆ·
   */
  suspend(reason?: string): void {
    if (this._status === UserStatus.SUSPENDED) {
      throw new Error('ç”¨æˆ·å·²ç»æ˜¯æš‚åœçŠ¶æ€');
    }

    if (this._status === UserStatus.DISABLED) {
      throw new Error('å·²ç¦ç”¨çš„ç”¨æˆ·ä¸èƒ½æš‚åœ');
    }

    const previousStatus = this._status;
    this._status = UserStatus.SUSPENDED;
    this.updateTimestamp();

    this.addDomainEvent(
      new UserSuspendedEvent(
        this.id.value,
        reason || 'ç®¡ç†å‘˜æš‚åœ',
        this._tenantId.value,
      ),
    );
  }

  /**
   * @method assignToOrganization
   * @description åˆ†é…ç”¨æˆ·åˆ°ç»„ç»‡
   */
  assignToOrganization(organizationId: Uuid): void {
    if (this._organizationId.equals(organizationId)) {
      return; // å·²ç»åœ¨è¯¥ç»„ç»‡ä¸­
    }

    const previousOrganizationId = this._organizationId;
    this._organizationId = organizationId;
    this.updateTimestamp();

    this.addDomainEvent(
      new UserOrganizationChangedEvent(
        this.id.value,
        previousOrganizationId.value,
        organizationId.value,
        this._tenantId.value,
      ),
    );
  }

  /**
   * @method addToDepartment
   * @description æ·»åŠ ç”¨æˆ·åˆ°éƒ¨é—¨
   */
  addToDepartment(departmentId: Uuid): void {
    if (this._departmentIds.has(departmentId)) {
      return; // å·²ç»åœ¨è¯¥éƒ¨é—¨ä¸­
    }

    this._departmentIds.add(departmentId);
    this.updateTimestamp();

    this.addDomainEvent(
      new UserDepartmentAssignedEvent(
        this.id.value,
        departmentId.value,
        this._tenantId.value,
      ),
    );
  }

  /**
   * @method assignRole
   * @description åˆ†é…è§’è‰²ç»™ç”¨æˆ·
   */
  assignRole(roleId: Uuid): void {
    if (this._roleIds.has(roleId)) {
      return; // å·²ç»æœ‰è¯¥è§’è‰²
    }

    this._roleIds.add(roleId);
    this.updateTimestamp();

    this.addDomainEvent(
      new UserRoleAssignedEvent(
        this.id.value,
        roleId.value,
        this._tenantId.value,
      ),
    );
  }

  /**
   * @method updateProfile
   * @description æ›´æ–°ç”¨æˆ·æ¡£æ¡ˆ
   */
  updateProfile(profile: Partial<UserProfile>): void {
    const previousProfile = { ...this._profile };
    this._profile = { ...this._profile, ...profile };
    this.updateTimestamp();

    this.addDomainEvent(
      new UserProfileUpdatedEvent(
        this.id.value,
        previousProfile,
        this._profile,
        this._tenantId.value,
      ),
    );
  }

  /**
   * @method recordLogin
   * @description è®°å½•ç”¨æˆ·ç™»å½•
   */
  recordLogin(): void {
    this._lastLoginAt = new Date();
    this._failedLoginAttempts = 0; // é‡ç½®å¤±è´¥æ¬¡æ•°
    this.updateTimestamp();

    this.addDomainEvent(
      new UserLoginRecordedEvent(
        this.id.value,
        this._lastLoginAt,
        this._tenantId.value,
      ),
    );
  }

  /**
   * @method recordFailedLogin
   * @description è®°å½•å¤±è´¥ç™»å½•
   */
  recordFailedLogin(): void {
    this._failedLoginAttempts++;
    this.updateTimestamp();

    // å¦‚æœå¤±è´¥æ¬¡æ•°è¿‡å¤šï¼Œé”å®šç”¨æˆ·
    if (this._failedLoginAttempts >= 5) {
      this.lock('è¿ç»­ç™»å½•å¤±è´¥è¿‡å¤š');
    }

    this.addDomainEvent(
      new UserLoginFailedEvent(
        this.id.value,
        this._failedLoginAttempts,
        this._tenantId.value,
      ),
    );
  }

  /**
   * @method lock
   * @description é”å®šç”¨æˆ·
   */
  private lock(reason: string): void {
    const previousStatus = this._status;
    this._status = UserStatus.LOCKED;

    this.addDomainEvent(
      new UserLockedEvent(this.id.value, reason, this._tenantId.value),
    );
  }

  /**
   * @method isActive
   * @description åˆ¤æ–­ç”¨æˆ·æ˜¯å¦æ´»è·ƒ
   */
  isActive(): boolean {
    return this._status === UserStatus.ACTIVE;
  }

  /**
   * @method canLogin
   * @description åˆ¤æ–­ç”¨æˆ·æ˜¯å¦å¯ä»¥ç™»å½•
   */
  canLogin(): boolean {
    return this._status === UserStatus.ACTIVE;
  }

  // é¢†åŸŸäº‹ä»¶ç®¡ç†

  /**
   * @private
   * @method addDomainEvent
   * @description æ·»åŠ é¢†åŸŸäº‹ä»¶
   */
  private addDomainEvent(event: UserDomainEvent): void {
    this._domainEvents.push(event);
  }

  /**
   * @method clearDomainEvents
   * @description æ¸…é™¤é¢†åŸŸäº‹ä»¶
   */
  clearDomainEvents(): void {
    this._domainEvents = [];
  }

  // é™æ€å·¥å‚æ–¹æ³•

  /**
   * @static
   * @method create
   * @description åˆ›å»ºæ–°ç”¨æˆ·
   */
  static create(
    username: string,
    email: string,
    organizationId: string,
    tenantId: string,
    profile: UserProfile,
    roleIds?: string[],
  ): User {
    const userId = Uuid.generate();
    const usernameVo = Username.create(username);
    const emailVo = Email.create(email);
    const organizationIdVo = Uuid.fromString(organizationId);
    const tenantIdVo = Uuid.fromString(tenantId);

    const user = new User(
      userId,
      usernameVo,
      emailVo,
      organizationIdVo,
      tenantIdVo,
      profile,
      UserStatus.PENDING,
    );

    // åˆ†é…è§’è‰²
    if (roleIds) {
      roleIds.forEach(roleId => {
        user.assignRole(Uuid.fromString(roleId));
      });
    }

    // å‘å¸ƒç”¨æˆ·åˆ›å»ºäº‹ä»¶
    user.addDomainEvent(
      UserCreatedEvent.create(
        userId.value,
        username,
        email,
        organizationId,
        profile,
        roleIds,
        tenantId,
      ),
    );

    return user;
  }
}
```

### æ­¥éª¤4: åˆ›å»ºèšåˆæ ¹

èšåˆæ ¹ç®¡ç†èšåˆè¾¹ç•Œå’Œä¸€è‡´æ€§ï¼š

```typescript
// domain/aggregates/user-aggregate.ts
import { User } from '../entities/user.entity';
import { UserRepository } from '../repositories/user.repository';

/**
 * @class UserAggregate
 * @description ç”¨æˆ·èšåˆæ ¹
 *
 * ä¸»è¦åŸç†ä¸æœºåˆ¶ï¼š
 * 1. ç®¡ç†ç”¨æˆ·èšåˆçš„è¾¹ç•Œå’Œä¸€è‡´æ€§
 * 2. åè°ƒèšåˆå†…çš„å®ä½“å’Œå€¼å¯¹è±¡
 * 3. ç¡®ä¿ä¸šåŠ¡è§„åˆ™çš„å®Œæ•´æ€§
 * 4. ç®¡ç†é¢†åŸŸäº‹ä»¶çš„å‘å¸ƒ
 *
 * åŠŸèƒ½ä¸ä¸šåŠ¡è§„åˆ™ï¼š
 * 1. ç”¨æˆ·èšåˆçš„ç”Ÿå‘½å‘¨æœŸç®¡ç†
 * 2. è·¨å®ä½“çš„ä¸šåŠ¡è§„åˆ™éªŒè¯
 * 3. èšåˆå†…æ•°æ®ä¸€è‡´æ€§ä¿è¯
 */
export class UserAggregate {
  private readonly user: User;

  constructor(user: User) {
    this.user = user;
  }

  get root(): User {
    return this.user;
  }

  /**
   * @method processCompleteUserSetup
   * @description å¤„ç†ç”¨æˆ·å®Œæ•´è®¾ç½®æµç¨‹
   */
  async processCompleteUserSetup(
    departmentIds: string[],
    additionalRoleIds: string[],
    userRepository: UserRepository,
  ): Promise<void> {
    // 1. éªŒè¯ç”¨æˆ·çŠ¶æ€
    if (!this.user.canLogin()) {
      throw new Error('ç”¨æˆ·çŠ¶æ€ä¸å…è®¸è®¾ç½®');
    }

    // 2. éªŒè¯éƒ¨é—¨å½’å±
    if (departmentIds.length === 0) {
      throw new Error('ç”¨æˆ·å¿…é¡»å½’å±è‡³å°‘ä¸€ä¸ªéƒ¨é—¨');
    }

    // 3. åˆ†é…éƒ¨é—¨
    departmentIds.forEach(deptId => {
      this.user.addToDepartment(Uuid.fromString(deptId));
    });

    // 4. åˆ†é…é¢å¤–è§’è‰²
    additionalRoleIds.forEach(roleId => {
      this.user.assignRole(Uuid.fromString(roleId));
    });

    // 5. æ¿€æ´»ç”¨æˆ·
    this.user.activate();

    // 6. éªŒè¯èšåˆä¸€è‡´æ€§
    this.validateAggregateConsistency();
  }

  /**
   * @private
   * @method validateAggregateConsistency
   * @description éªŒè¯èšåˆä¸€è‡´æ€§
   */
  private validateAggregateConsistency(): void {
    // éªŒè¯ç”¨æˆ·å¿…é¡»æœ‰éƒ¨é—¨
    if (this.user.departmentIds.size === 0) {
      throw new Error('ç”¨æˆ·å¿…é¡»å½’å±è‡³å°‘ä¸€ä¸ªéƒ¨é—¨');
    }

    // éªŒè¯ç”¨æˆ·å¿…é¡»æœ‰è§’è‰²
    if (this.user.roleIds.size === 0) {
      throw new Error('ç”¨æˆ·å¿…é¡»æ‹¥æœ‰è‡³å°‘ä¸€ä¸ªè§’è‰²');
    }

    // éªŒè¯ç”¨æˆ·çŠ¶æ€åˆæ³•æ€§
    if (this.user.isActive() && this.user.departmentIds.size === 0) {
      throw new Error('æ´»è·ƒç”¨æˆ·å¿…é¡»å½’å±éƒ¨é—¨');
    }
  }

  /**
   * @method getDomainEvents
   * @description è·å–èšåˆçš„é¢†åŸŸäº‹ä»¶
   */
  getDomainEvents(): UserDomainEvent[] {
    return this.user.domainEvents;
  }

  /**
   * @method clearDomainEvents
   * @description æ¸…é™¤èšåˆçš„é¢†åŸŸäº‹ä»¶
   */
  clearDomainEvents(): void {
    this.user.clearDomainEvents();
  }
}
```

### æ­¥éª¤5: åˆ›å»ºé¢†åŸŸæœåŠ¡

é¢†åŸŸæœåŠ¡å¤„ç†è·¨èšåˆçš„å¤æ‚ä¸šåŠ¡é€»è¾‘ï¼š

```typescript
// domain/services/user-domain.service.ts
import { Injectable } from '@nestjs/common';
import { UserRepository } from '../repositories/user.repository';
import { OrganizationRepository } from '../../organization/domain/repositories/organization.repository';

/**
 * @class UserDomainService
 * @description ç”¨æˆ·é¢†åŸŸæœåŠ¡
 *
 * ä¸»è¦åŸç†ä¸æœºåˆ¶ï¼š
 * 1. å¤„ç†è·¨èšåˆçš„ä¸šåŠ¡é€»è¾‘
 * 2. åè°ƒå¤šä¸ªä»“å‚¨å’Œèšåˆ
 * 3. å®ç°å¤æ‚çš„ä¸šåŠ¡è§„åˆ™éªŒè¯
 * 4. ä¿æŒé¢†åŸŸé€»è¾‘çš„çº¯ç²¹æ€§
 *
 * åŠŸèƒ½ä¸ä¸šåŠ¡è§„åˆ™ï¼š
 * 1. ç”¨æˆ·å”¯ä¸€æ€§éªŒè¯
 * 2. è·¨ç»„ç»‡çš„ç”¨æˆ·ç®¡ç†
 * 3. ç”¨æˆ·æƒé™ç»§æ‰¿è§„åˆ™
 * 4. å¤æ‚çš„ä¸šåŠ¡çº¦æŸæ£€æŸ¥
 */
@Injectable()
export class UserDomainService {
  constructor(
    private readonly userRepository: UserRepository,
    private readonly organizationRepository: OrganizationRepository,
  ) {}

  /**
   * @method validateUserCreation
   * @description éªŒè¯ç”¨æˆ·åˆ›å»ºçš„ä¸šåŠ¡è§„åˆ™
   */
  async validateUserCreation(
    username: string,
    email: string,
    organizationId: string,
    tenantId: string,
  ): Promise<void> {
    // 1. éªŒè¯ç”¨æˆ·åå”¯ä¸€æ€§ï¼ˆç§Ÿæˆ·çº§åˆ«ï¼‰
    const existingUserByUsername = await this.userRepository.findByUsername(
      username,
      tenantId,
    );
    if (existingUserByUsername) {
      throw new Error(`ç”¨æˆ·å "${username}" åœ¨è¯¥ç§Ÿæˆ·ä¸­å·²å­˜åœ¨`);
    }

    // 2. éªŒè¯é‚®ç®±å”¯ä¸€æ€§ï¼ˆå…¨å±€çº§åˆ«ï¼‰
    const existingUserByEmail = await this.userRepository.findByEmail(email);
    if (existingUserByEmail) {
      throw new Error(`é‚®ç®± "${email}" å·²è¢«ä½¿ç”¨`);
    }

    // 3. éªŒè¯ç»„ç»‡æ˜¯å¦å­˜åœ¨ä¸”æ´»è·ƒ
    const organization =
      await this.organizationRepository.findById(organizationId);
    if (!organization) {
      throw new Error(`ç»„ç»‡ "${organizationId}" ä¸å­˜åœ¨`);
    }

    if (!organization.isActive()) {
      throw new Error(`ç»„ç»‡ "${organization.name}" ä¸æ˜¯æ´»è·ƒçŠ¶æ€`);
    }

    // 4. éªŒè¯ç»„ç»‡æ˜¯å¦å±äºæŒ‡å®šç§Ÿæˆ·
    if (!organization.belongsToTenant(tenantId)) {
      throw new Error('ç»„ç»‡ä¸å±äºæŒ‡å®šç§Ÿæˆ·');
    }
  }

  /**
   * @method validateUserTransfer
   * @description éªŒè¯ç”¨æˆ·è½¬ç§»çš„ä¸šåŠ¡è§„åˆ™
   */
  async validateUserTransfer(
    userId: string,
    fromOrganizationId: string,
    toOrganizationId: string,
    tenantId: string,
  ): Promise<void> {
    // 1. éªŒè¯ç”¨æˆ·å­˜åœ¨
    const user = await this.userRepository.findById(userId);
    if (!user) {
      throw new Error(`ç”¨æˆ· "${userId}" ä¸å­˜åœ¨`);
    }

    // 2. éªŒè¯ç”¨æˆ·å½“å‰ç»„ç»‡
    if (user.organizationId.value !== fromOrganizationId) {
      throw new Error('ç”¨æˆ·ä¸å±äºæŒ‡å®šçš„æºç»„ç»‡');
    }

    // 3. éªŒè¯ç›®æ ‡ç»„ç»‡
    const targetOrganization =
      await this.organizationRepository.findById(toOrganizationId);
    if (!targetOrganization) {
      throw new Error(`ç›®æ ‡ç»„ç»‡ "${toOrganizationId}" ä¸å­˜åœ¨`);
    }

    if (!targetOrganization.isActive()) {
      throw new Error('ç›®æ ‡ç»„ç»‡ä¸æ˜¯æ´»è·ƒçŠ¶æ€');
    }

    // 4. éªŒè¯ç»„ç»‡é—´è½¬ç§»è§„åˆ™
    if (!targetOrganization.belongsToTenant(tenantId)) {
      throw new Error('ç›®æ ‡ç»„ç»‡ä¸å±äºåŒä¸€ç§Ÿæˆ·');
    }

    // 5. æ£€æŸ¥ç”¨æˆ·æ˜¯å¦æœ‰æœªå®Œæˆçš„ä»»åŠ¡
    const hasPendingTasks = await this.checkUserPendingTasks(userId);
    if (hasPendingTasks) {
      throw new Error('ç”¨æˆ·æœ‰æœªå®Œæˆçš„ä»»åŠ¡ï¼Œä¸èƒ½è½¬ç§»ç»„ç»‡');
    }
  }

  /**
   * @method calculateUserPermissions
   * @description è®¡ç®—ç”¨æˆ·çš„æœ‰æ•ˆæƒé™
   */
  async calculateUserPermissions(userId: string): Promise<string[]> {
    const user = await this.userRepository.findById(userId);
    if (!user) {
      throw new Error(`ç”¨æˆ· "${userId}" ä¸å­˜åœ¨`);
    }

    const permissions = new Set<string>();

    // 1. æ”¶é›†è§’è‰²æƒé™
    for (const roleId of user.roleIds) {
      const rolePermissions = await this.getRolePermissions(roleId.value);
      rolePermissions.forEach(permission => permissions.add(permission));
    }

    // 2. æ”¶é›†ç»„ç»‡æƒé™
    const orgPermissions = await this.getOrganizationPermissions(
      user.organizationId.value,
    );
    orgPermissions.forEach(permission => permissions.add(permission));

    // 3. æ”¶é›†éƒ¨é—¨æƒé™
    for (const deptId of user.departmentIds) {
      const deptPermissions = await this.getDepartmentPermissions(deptId.value);
      deptPermissions.forEach(permission => permissions.add(permission));
    }

    return Array.from(permissions);
  }

  /**
   * @private
   * @method checkUserPendingTasks
   * @description æ£€æŸ¥ç”¨æˆ·æ˜¯å¦æœ‰æœªå®Œæˆçš„ä»»åŠ¡
   */
  private async checkUserPendingTasks(userId: string): Promise<boolean> {
    // è¿™é‡Œä¼šè°ƒç”¨ä»»åŠ¡ç®¡ç†ç³»ç»Ÿçš„API
    // æš‚æ—¶è¿”å›false
    return false;
  }

  /**
   * @private
   * @method getRolePermissions
   * @description è·å–è§’è‰²æƒé™
   */
  private async getRolePermissions(roleId: string): Promise<string[]> {
    // å®ç°è§’è‰²æƒé™æŸ¥è¯¢
    return [];
  }

  /**
   * @private
   * @method getOrganizationPermissions
   * @description è·å–ç»„ç»‡æƒé™
   */
  private async getOrganizationPermissions(orgId: string): Promise<string[]> {
    // å®ç°ç»„ç»‡æƒé™æŸ¥è¯¢
    return [];
  }

  /**
   * @private
   * @method getDepartmentPermissions
   * @description è·å–éƒ¨é—¨æƒé™
   */
  private async getDepartmentPermissions(deptId: string): Promise<string[]> {
    // å®ç°éƒ¨é—¨æƒé™æŸ¥è¯¢
    return [];
  }
}
```

### æ­¥éª¤6: åˆ›å»ºä»“å‚¨æ¥å£

ä»“å‚¨æ¥å£å®šä¹‰æ•°æ®è®¿é—®å¥‘çº¦ï¼š

```typescript
// domain/repositories/user.repository.ts
import { User } from '../entities/user.entity';
import { Uuid } from '@aiofix/domain-shared';

/**
 * @interface UserRepository
 * @description ç”¨æˆ·ä»“å‚¨æ¥å£
 *
 * ä¸»è¦åŸç†ä¸æœºåˆ¶ï¼š
 * 1. å®šä¹‰ç”¨æˆ·æ•°æ®è®¿é—®çš„å¥‘çº¦
 * 2. éš”ç¦»é¢†åŸŸå±‚å’ŒåŸºç¡€è®¾æ–½å±‚
 * 3. æ”¯æŒä¸åŒçš„å­˜å‚¨å®ç°
 * 4. ä¿æŒé¢†åŸŸé€»è¾‘çš„çº¯ç²¹æ€§
 *
 * åŠŸèƒ½ä¸ä¸šåŠ¡è§„åˆ™ï¼š
 * 1. åŸºç¡€CRUDæ“ä½œ
 * 2. ä¸šåŠ¡æŸ¥è¯¢æ–¹æ³•
 * 3. äº‹åŠ¡ç®¡ç†æ”¯æŒ
 * 4. å¹¶å‘æ§åˆ¶æ”¯æŒ
 */
export interface UserRepository {
  /**
   * @method save
   * @description ä¿å­˜ç”¨æˆ·èšåˆ
   */
  save(user: User): Promise<void>;

  /**
   * @method findById
   * @description æ ¹æ®IDæŸ¥æ‰¾ç”¨æˆ·
   */
  findById(id: Uuid): Promise<User | null>;

  /**
   * @method findByUsername
   * @description æ ¹æ®ç”¨æˆ·åæŸ¥æ‰¾ç”¨æˆ·
   */
  findByUsername(username: string, tenantId: string): Promise<User | null>;

  /**
   * @method findByEmail
   * @description æ ¹æ®é‚®ç®±æŸ¥æ‰¾ç”¨æˆ·
   */
  findByEmail(email: string): Promise<User | null>;

  /**
   * @method findByOrganization
   * @description æŸ¥æ‰¾ç»„ç»‡ä¸‹çš„ç”¨æˆ·
   */
  findByOrganization(organizationId: Uuid, tenantId: string): Promise<User[]>;

  /**
   * @method findByDepartment
   * @description æŸ¥æ‰¾éƒ¨é—¨ä¸‹çš„ç”¨æˆ·
   */
  findByDepartment(departmentId: Uuid, tenantId: string): Promise<User[]>;

  /**
   * @method findActiveUsers
   * @description æŸ¥æ‰¾æ´»è·ƒç”¨æˆ·
   */
  findActiveUsers(tenantId: string): Promise<User[]>;

  /**
   * @method delete
   * @description åˆ é™¤ç”¨æˆ·
   */
  delete(id: Uuid): Promise<void>;

  /**
   * @method exists
   * @description æ£€æŸ¥ç”¨æˆ·æ˜¯å¦å­˜åœ¨
   */
  exists(id: Uuid): Promise<boolean>;

  /**
   * @method count
   * @description ç»Ÿè®¡ç”¨æˆ·æ•°é‡
   */
  count(tenantId: string): Promise<number>;
}
```

### æ­¥éª¤7: åˆ›å»ºé¢†åŸŸå¼‚å¸¸

å®šä¹‰ä¸šåŠ¡å¼‚å¸¸ï¼š

```typescript
// domain/exceptions/user.exception.ts
/**
 * @class UserDomainException
 * @description ç”¨æˆ·é¢†åŸŸå¼‚å¸¸åŸºç±»
 */
export abstract class UserDomainException extends Error {
  constructor(
    message: string,
    public readonly code: string,
    public readonly context?: Record<string, any>,
  ) {
    super(message);
    this.name = this.constructor.name;
  }
}

/**
 * @class UserNotFoundError
 * @description ç”¨æˆ·ä¸å­˜åœ¨å¼‚å¸¸
 */
export class UserNotFoundError extends UserDomainException {
  constructor(userId: string) {
    super(`ç”¨æˆ·ä¸å­˜åœ¨: ${userId}`, 'USER_NOT_FOUND', { userId });
  }
}

/**
 * @class UserAlreadyExistsError
 * @description ç”¨æˆ·å·²å­˜åœ¨å¼‚å¸¸
 */
export class UserAlreadyExistsError extends UserDomainException {
  constructor(field: string, value: string) {
    super(`ç”¨æˆ·å·²å­˜åœ¨: ${field} = ${value}`, 'USER_ALREADY_EXISTS', {
      field,
      value,
    });
  }
}

/**
 * @class InvalidUserStatusError
 * @description æ— æ•ˆç”¨æˆ·çŠ¶æ€å¼‚å¸¸
 */
export class InvalidUserStatusError extends UserDomainException {
  constructor(currentStatus: string, targetStatus: string) {
    super(
      `æ— æ•ˆçš„çŠ¶æ€è½¬æ¢: ä» ${currentStatus} åˆ° ${targetStatus}`,
      'INVALID_USER_STATUS',
      { currentStatus, targetStatus },
    );
  }
}
```

### æ­¥éª¤8: é…ç½®é¢†åŸŸæ¨¡å—

```typescript
// domain/user-domain.module.ts
import { Module } from '@nestjs/common';
import { UserDomainService } from './services/user-domain.service';

/**
 * @class UserDomainModule
 * @description ç”¨æˆ·é¢†åŸŸæ¨¡å—
 */
@Module({
  providers: [UserDomainService],
  exports: [UserDomainService],
})
export class UserDomainModule {}

// domain/index.ts
export * from './entities';
export * from './value-objects';
export * from './events';
export * from './aggregates';
export * from './services';
export * from './repositories';
export * from './exceptions';
export * from './user-domain.module';
```

---

## âš ï¸ é¢†åŸŸå±‚å¼€å‘è¦ç‚¹

### DO âœ… æœ€ä½³å®è·µ

1. **é‡‡ç”¨å……è¡€æ¨¡å‹**: å®ä½“å¿…é¡»å°è£…æ•°æ®å’Œè¡Œä¸ºï¼Œé¿å…è´«è¡€æ¨¡å‹
2. **å€¼å¯¹è±¡ä¸å¯å˜**: æ‰€æœ‰å€¼å¯¹è±¡åˆ›å»ºåä¸èƒ½ä¿®æ”¹
3. **å®ä½“å°è£…ä¸šåŠ¡é€»è¾‘**: ä¸šåŠ¡è§„åˆ™å¿…é¡»åœ¨å®ä½“å†…éƒ¨ï¼Œè€Œéå¤–éƒ¨Service
4. **èšåˆæ ¹ç®¡ç†ä¸€è‡´æ€§**: é€šè¿‡èšåˆæ ¹ç»´æŠ¤æ•°æ®ä¸€è‡´æ€§
5. **é¢†åŸŸäº‹ä»¶è®°å½•å˜æ›´**: æ‰€æœ‰é‡è¦ä¸šåŠ¡å˜æ›´éƒ½è¦å‘å¸ƒäº‹ä»¶
6. **é¢†åŸŸæœåŠ¡å¤„ç†è·¨èšåˆé€»è¾‘**: å¤æ‚ä¸šåŠ¡è§„åˆ™æ”¾åœ¨é¢†åŸŸæœåŠ¡
7. **ä»“å‚¨æ¥å£åœ¨é¢†åŸŸå±‚**: å®šä¹‰æ•°æ®è®¿é—®å¥‘çº¦
8. **ä½¿ç”¨é€šç”¨è¯­è¨€**: ä»£ç åæ˜ ä¸šåŠ¡æ¦‚å¿µ
9. **å¼‚å¸¸è¡¨è¾¾ä¸šåŠ¡è§„åˆ™**: é€šè¿‡å¼‚å¸¸ä¼ è¾¾ä¸šåŠ¡çº¦æŸ
10. **æ–¹æ³•è¡¨è¾¾ä¸šåŠ¡åŠ¨ä½œ**: ç”¨æœ‰æ„ä¹‰çš„æ–¹æ³•åè¡¨è¾¾ä¸šåŠ¡æ“ä½œ

### DON'T âŒ åæ¨¡å¼ä¸çº¯å‡€æ€§è¿è§„

#### ğŸš¨ ä¸¥é‡è¿è§„ï¼ˆç ´åçº¯å‡€æ€§ï¼‰

1. **ä¸è¦ä½¿ç”¨è´«è¡€æ¨¡å‹**

   ```typescript
   // âŒ é”™è¯¯ï¼šè´«è¡€æ¨¡å‹ï¼Œåªæœ‰æ•°æ®æ²¡æœ‰è¡Œä¸º
   export class User {
     public id: string;
     public username: string;
     public status: UserStatus;

     // åªæœ‰ç®€å•çš„getter/setterï¼Œæ²¡æœ‰ä¸šåŠ¡é€»è¾‘
     getStatus(): UserStatus {
       return this.status;
     }

     setStatus(status: UserStatus): void {
       this.status = status; // ç›´æ¥ä¿®æ”¹ï¼Œæ²¡æœ‰ä¸šåŠ¡è§„åˆ™éªŒè¯
     }
   }

   // ä¸šåŠ¡é€»è¾‘è¢«è¿«æ”¾åœ¨å¤–éƒ¨Serviceä¸­
   export class UserService {
     activateUser(user: User): void {
       if (user.getStatus() === UserStatus.ACTIVE) {
         throw new Error('ç”¨æˆ·å·²æ¿€æ´»');
       }
       user.setStatus(UserStatus.ACTIVE);
     }
   }

   // âœ… æ­£ç¡®ï¼šå……è¡€æ¨¡å‹ï¼Œå°è£…æ•°æ®å’Œè¡Œä¸º
   export class User extends BaseEntity {
     private _status: UserStatus;

     activate(): void {
       if (this._status === UserStatus.ACTIVE) {
         throw new Error('ç”¨æˆ·å·²ç»æ˜¯æ¿€æ´»çŠ¶æ€');
       }

       if (this._status === UserStatus.DISABLED) {
         throw new Error('å·²ç¦ç”¨çš„ç”¨æˆ·ä¸èƒ½æ¿€æ´»');
       }

       const previousStatus = this._status;
       this._status = UserStatus.ACTIVE;
       this.updateTimestamp();

       this.addDomainEvent(
         new UserStatusChangedEvent(
           this.id.value,
           previousStatus,
           UserStatus.ACTIVE,
         ),
       );
     }
   }
   ```

2. **ä¸è¦åœ¨é¢†åŸŸå®ä½“ä¸­ä½¿ç”¨ORMè£…é¥°å™¨**

   ```typescript
   // âŒ é”™è¯¯ï¼šæ±¡æŸ“äº†é¢†åŸŸå®ä½“
   @Entity('users')
   export class User extends BaseEntity {
     @PrimaryGeneratedColumn('uuid')
     id: string;

     @Column()
     username: string;
   }

   // âœ… æ­£ç¡®ï¼šçº¯å‡€çš„é¢†åŸŸå®ä½“
   export class User extends BaseEntity {
     private _username: Username;

     constructor(id: Uuid, username: Username) {
       super(id);
       this._username = username;
     }
   }
   ```

3. **ä¸è¦åœ¨é¢†åŸŸå±‚ç›´æ¥ä¾èµ–ç¬¬ä¸‰æ–¹åº“**

   ```typescript
   // âŒ é”™è¯¯ï¼šå¼•å…¥å¤–éƒ¨ä¾èµ–
   import axios from 'axios';
   import moment from 'moment';
   import _ from 'lodash';

   export class User {
     async validateEmail() {
       return axios.post('/validate', { email: this.email });
     }
   }

   // âœ… æ­£ç¡®ï¼šé€šè¿‡æ¥å£æŠ½è±¡å¤–éƒ¨ä¾èµ–
   export class User {
     async validateEmail(validator: EmailValidator) {
       return validator.validate(this.email);
     }
   }
   ```

4. **ä¸è¦åœ¨å®ä½“ä¸­åŒ…å«åŸºç¡€è®¾æ–½ä»£ç **

   ```typescript
   // âŒ é”™è¯¯ï¼šåŒ…å«åŸºç¡€è®¾æ–½å…³æ³¨ç‚¹
   export class User {
     async save() {
       await db.users.save(this); // æ•°æ®åº“æ“ä½œ
       await redis.set(`user:${this.id}`, this); // ç¼“å­˜æ“ä½œ
       await emailService.send(this.email, 'welcome'); // å¤–éƒ¨æœåŠ¡
     }
   }

   // âœ… æ­£ç¡®ï¼šçº¯ç²¹çš„ä¸šåŠ¡é€»è¾‘
   export class User {
     updateProfile(profile: UserProfile): void {
       this.validateProfile(profile);
       this._profile = profile;
       this.updateTimestamp();
       this.addDomainEvent(new UserProfileUpdatedEvent(...));
     }
   }
   ```

#### âš ï¸ ä¸€èˆ¬åæ¨¡å¼

4. **ä¸è¦è·¨èšåˆç›´æ¥å¼•ç”¨**: é€šè¿‡IDå¼•ç”¨å…¶ä»–èšåˆ
5. **ä¸è¦åœ¨å€¼å¯¹è±¡ä¸­å†™ä¸šåŠ¡é€»è¾‘**: å€¼å¯¹è±¡åªè´Ÿè´£æ•°æ®éªŒè¯
6. **ä¸è¦å¿½ç•¥é¢†åŸŸäº‹ä»¶**: é‡è¦çŠ¶æ€å˜æ›´å¿…é¡»å‘å¸ƒäº‹ä»¶
7. **ä¸è¦è®©é¢†åŸŸå±‚ä¾èµ–å¤–å±‚**: ä¿æŒä¾èµ–æ–¹å‘æ­£ç¡®
8. **ä¸è¦åœ¨é¢†åŸŸå±‚å¤„ç†æŠ€æœ¯å…³æ³¨ç‚¹**: äº‹åŠ¡ã€ç¼“å­˜ç­‰æ”¾åœ¨åŸºç¡€è®¾æ–½å±‚
9. **ä¸è¦ç ´åèšåˆè¾¹ç•Œ**: ä¸€ä¸ªäº‹åŠ¡åªèƒ½ä¿®æ”¹ä¸€ä¸ªèšåˆ
10. **ä¸è¦å¿½è§†å®ä½“çš„è¡Œä¸ºè®¾è®¡**: æ¯ä¸ªå®ä½“éƒ½åº”è¯¥æœ‰ä¸°å¯Œçš„ä¸šåŠ¡æ–¹æ³•

#### ğŸ” çº¯å‡€æ€§æ£€æŸ¥æ¸…å•

åœ¨å¼€å‘é¢†åŸŸå±‚æ—¶ï¼Œç¡®ä¿ï¼š

- [ ] é‡‡ç”¨å……è¡€æ¨¡å‹ï¼Œå®ä½“åŒ…å«ä¸°å¯Œçš„ä¸šåŠ¡æ–¹æ³•
- [ ] æ²¡æœ‰è´«è¡€æ¨¡å‹ï¼Œé¿å…åªæœ‰getter/setterçš„æ•°æ®å®¹å™¨
- [ ] æ²¡æœ‰ä»»ä½•ORMç›¸å…³çš„è£…é¥°å™¨æˆ–æ³¨è§£
- [ ] æ²¡æœ‰å¯¼å…¥ä»»ä½•æ•°æ®åº“ç›¸å…³çš„åº“
- [ ] æ²¡æœ‰å¯¼å…¥ä»»ä½•HTTPæ¡†æ¶ç›¸å…³çš„è£…é¥°å™¨
- [ ] æ²¡æœ‰å¯¼å…¥ä»»ä½•ç¬¬ä¸‰æ–¹å·¥å…·åº“
- [ ] æ‰€æœ‰ä¾èµ–éƒ½é€šè¿‡æ¥å£æŠ½è±¡
- [ ] åªåŒ…å«çº¯ç²¹çš„ä¸šåŠ¡é€»è¾‘
- [ ] ä¸šåŠ¡é€»è¾‘å°è£…åœ¨å®ä½“å†…éƒ¨ï¼Œè€Œéå¤–éƒ¨Service
- [ ] å¯ä»¥åœ¨æ²¡æœ‰ä»»ä½•åŸºç¡€è®¾æ–½çš„æƒ…å†µä¸‹è¿›è¡Œå•å…ƒæµ‹è¯•

---

## ğŸ§ª é¢†åŸŸå±‚æµ‹è¯•æŒ‡å—

### çº¯å‡€æ€§å¸¦æ¥çš„æµ‹è¯•ä¼˜åŠ¿

ç”±äºé¢†åŸŸå±‚ä¿æŒäº†ç»å¯¹çš„çº¯å‡€æ€§ï¼Œæµ‹è¯•å…·æœ‰ä»¥ä¸‹ä¼˜åŠ¿ï¼š

- **æ— éœ€MockåŸºç¡€è®¾æ–½**: ä¸ä¾èµ–æ•°æ®åº“ã€HTTPã€æ–‡ä»¶ç³»ç»Ÿç­‰
- **æµ‹è¯•é€Ÿåº¦æå¿«**: çº¯å†…å­˜è¿è¡Œï¼Œæ— I/Oæ“ä½œ
- **å®Œå…¨å¯æ§**: æ‰€æœ‰è¾“å…¥è¾“å‡ºéƒ½æ˜¯ç¡®å®šçš„
- **æ˜“äºè°ƒè¯•**: æ²¡æœ‰å¤–éƒ¨ä¾èµ–çš„å¹²æ‰°
- **100%è¦†ç›–ç‡**: å¯ä»¥è½»æ¾æµ‹è¯•æ‰€æœ‰ä»£ç è·¯å¾„

### å®ä½“æµ‹è¯•ï¼ˆçº¯å‡€æ€§ç¤ºä¾‹ï¼‰

```typescript
describe('User Entity', () => {
  let user: User;

  beforeEach(() => {
    user = User.create(
      'testuser',
      'test@example.com',
      'org-123',
      'tenant-123',
      {
        firstName: 'Test',
        lastName: 'User',
      },
    );
  });

  describe('activate', () => {
    it('should activate pending user', () => {
      // Act
      user.activate();

      // Assert
      expect(user.status).toBe(UserStatus.ACTIVE);
      expect(user.domainEvents).toHaveLength(2); // Created + StatusChanged
    });

    it('should throw error when user already active', () => {
      // Arrange
      user.activate();

      // Act & Assert
      expect(() => user.activate()).toThrow('ç”¨æˆ·å·²ç»æ˜¯æ¿€æ´»çŠ¶æ€');
    });
  });
});
```

### å€¼å¯¹è±¡æµ‹è¯•

```typescript
describe('Username Value Object', () => {
  describe('creation', () => {
    it('should create valid username', () => {
      // Act
      const username = Username.create('validuser');

      // Assert
      expect(username.value).toBe('validuser');
    });

    it('should throw error for invalid username', () => {
      // Act & Assert
      expect(() => Username.create('ab')).toThrow(
        'ç”¨æˆ·åé•¿åº¦å¿…é¡»åœ¨3-50å­—ç¬¦ä¹‹é—´',
      );
      expect(() => Username.create('invalid-user')).toThrow(
        'ç”¨æˆ·ååªèƒ½åŒ…å«å­—æ¯ã€æ•°å­—å’Œä¸‹åˆ’çº¿',
      );
    });
  });

  describe('equality', () => {
    it('should be equal for same values', () => {
      // Arrange
      const username1 = Username.create('testuser');
      const username2 = Username.create('testuser');

      // Act & Assert
      expect(username1.equals(username2)).toBe(true);
    });
  });
});
```

### é¢†åŸŸæœåŠ¡æµ‹è¯•

```typescript
describe('UserDomainService', () => {
  let service: UserDomainService;
  let userRepository: jest.Mocked<UserRepository>;
  let organizationRepository: jest.Mocked<OrganizationRepository>;

  beforeEach(() => {
    userRepository = {
      findByUsername: jest.fn(),
      findByEmail: jest.fn(),
    } as any;

    organizationRepository = {
      findById: jest.fn(),
    } as any;

    service = new UserDomainService(userRepository, organizationRepository);
  });

  describe('validateUserCreation', () => {
    it('should validate successfully for valid data', async () => {
      // Arrange
      userRepository.findByUsername.mockResolvedValue(null);
      userRepository.findByEmail.mockResolvedValue(null);
      organizationRepository.findById.mockResolvedValue(mockActiveOrganization);

      // Act & Assert
      await expect(
        service.validateUserCreation(
          'newuser',
          'new@example.com',
          'org-123',
          'tenant-123',
        ),
      ).resolves.not.toThrow();
    });

    it('should throw error for duplicate username', async () => {
      // Arrange
      userRepository.findByUsername.mockResolvedValue(mockExistingUser);

      // Act & Assert
      await expect(
        service.validateUserCreation(
          'existinguser',
          'new@example.com',
          'org-123',
          'tenant-123',
        ),
      ).rejects.toThrow('ç”¨æˆ·å "existinguser" åœ¨è¯¥ç§Ÿæˆ·ä¸­å·²å­˜åœ¨');
    });
  });
});
```

---

## ğŸ“š å‚è€ƒèµ„æ–™

- [Domain-Driven Design](https://martinfowler.com/bliki/DomainDrivenDesign.html)
- [Aggregate Pattern](https://martinfowler.com/bliki/DDD_Aggregate.html)
- [Value Object](https://martinfowler.com/bliki/ValueObject.html)
- [Domain Events](https://martinfowler.com/eaaDev/DomainEvent.html)
- [Repository Pattern](https://martinfowler.com/eaaCatalog/repository.html)

---

## ğŸ¯ æ€»ç»“

é¢†åŸŸå±‚æ˜¯æ··åˆæ¶æ„çš„**ä¸šåŠ¡æ ¸å¿ƒ**ï¼Œéµå¾ªä»¥ä¸‹å…³é”®åŸåˆ™ï¼š

### æ ¸å¿ƒç†å¿µ

1. **ä¸šåŠ¡ä¸ºä¸­å¿ƒ**: æ‰€æœ‰è®¾è®¡éƒ½å›´ç»•ä¸šåŠ¡æ¦‚å¿µ
2. **å……è¡€æ¨¡å‹**: å®ä½“å¿…é¡»å°è£…æ•°æ®å’Œè¡Œä¸ºï¼Œé¿å…è´«è¡€æ¨¡å‹
3. **ç»å¯¹çº¯å‡€æ€§**: é¢†åŸŸå±‚ä¸èƒ½æœ‰ä»»ä½•æŠ€æœ¯åŸºç¡€è®¾æ–½ä¾èµ–
4. **å°è£…ä¸šåŠ¡è§„åˆ™**: ä¸šåŠ¡é€»è¾‘é›†ä¸­åœ¨é¢†åŸŸå±‚çš„å®ä½“å†…éƒ¨
5. **äº‹ä»¶é©±åŠ¨**: é€šè¿‡äº‹ä»¶è®°å½•å’Œä¼ æ’­çŠ¶æ€å˜æ›´
6. **èšåˆä¸€è‡´æ€§**: é€šè¿‡èšåˆæ ¹ç»´æŠ¤æ•°æ®ä¸€è‡´æ€§

### è®¾è®¡æ¨¡å¼

1. **å®ä½“**: æœ‰èº«ä»½çš„ä¸šåŠ¡å¯¹è±¡ï¼Œå°è£…è¡Œä¸º
2. **å€¼å¯¹è±¡**: æ— èº«ä»½çš„ä¸å¯å˜å¯¹è±¡ï¼Œè¡¨è¾¾æ¦‚å¿µ
3. **èšåˆæ ¹**: ç®¡ç†èšåˆè¾¹ç•Œå’Œä¸€è‡´æ€§
4. **é¢†åŸŸæœåŠ¡**: å¤„ç†è·¨èšåˆçš„å¤æ‚é€»è¾‘
5. **é¢†åŸŸäº‹ä»¶**: è®°å½•é‡è¦çš„ä¸šåŠ¡çŠ¶æ€å˜æ›´

### å®æ–½ç­–ç•¥

1. å…ˆå»ºæ¨¡å€¼å¯¹è±¡å’Œäº‹ä»¶
2. å†è®¾è®¡å®ä½“å’Œèšåˆæ ¹
3. ç„¶åå®ç°é¢†åŸŸæœåŠ¡
4. æœ€åå®šä¹‰ä»“å‚¨æ¥å£

### åˆ†å±‚éš”ç¦»ç­–ç•¥

ä¸ºç¡®ä¿é¢†åŸŸå±‚çº¯å‡€æ€§ï¼Œé‡‡ç”¨ä»¥ä¸‹éš”ç¦»ç­–ç•¥ï¼š

```typescript
// é¢†åŸŸå±‚ï¼ˆçº¯å‡€ï¼‰
libs/domain/iam/src/user/domain/
â”œâ”€â”€ entities/user.entity.ts        # çº¯ä¸šåŠ¡é€»è¾‘
â”œâ”€â”€ value-objects/username.vo.ts   # çº¯æ•°æ®éªŒè¯
â”œâ”€â”€ events/user-created.event.ts   # çº¯äº‹ä»¶å®šä¹‰
â””â”€â”€ repositories/user.repository.ts # çº¯æ¥å£å®šä¹‰

// åŸºç¡€è®¾æ–½å±‚ï¼ˆæŠ€æœ¯å®ç°ï¼‰
libs/infrastructure/database/src/
â”œâ”€â”€ entities/user.orm-entity.ts    # ORMæ˜ å°„
â”œâ”€â”€ repositories/user.repository.impl.ts # ä»“å‚¨å®ç°
â””â”€â”€ mappers/user.mapper.ts         # é¢†åŸŸ-ORMæ˜ å°„
```

**å…³é”®éš”ç¦»åŸåˆ™ï¼š**

- é¢†åŸŸå®ä½“ â‰  ORMå®ä½“ï¼ˆå®Œå…¨åˆ†ç¦»ï¼‰
- é¢†åŸŸä»“å‚¨æ¥å£ â‰  ä»“å‚¨å®ç°ï¼ˆä¾èµ–å€’ç½®ï¼‰
- ä¸šåŠ¡é€»è¾‘ â‰  æŠ€æœ¯å®ç°ï¼ˆå®Œå…¨è§£è€¦ï¼‰

è¿™æ ·çš„é¢†åŸŸå±‚è®¾è®¡èƒ½å¤Ÿå……åˆ†ä½“ç°ä¸šåŠ¡ä»·å€¼ï¼Œæ”¯æŒå¤æ‚çš„ä¸šåŠ¡è§„åˆ™ï¼Œä¿æŒç»å¯¹çš„æŠ€æœ¯ç‹¬ç«‹æ€§ï¼Œå¹¶ä¸ºäº‹ä»¶æº¯æºæ¶æ„æä¾›åšå®çš„ä¸šåŠ¡åŸºç¡€ã€‚
